# گزارش به‌روزرسانی - سیستم احراز هویت meet.avinoo.ir

**تاریخ:** 13 ژانویه 2025  
**شماره گزارش:** 03  
**پروژه:** Auth Service - Meet Integration (به‌روزرسانی)  

## خلاصه تغییرات

مدل‌های غیرضروری حذف شدند و سیستم به صورت ساده‌تر و کارآمدتر پیاده‌سازی شد. حالا سیستم فقط از API خارجی استفاده می‌کند و JWT tokens را تولید می‌کند.

## فایل‌های حذف شده

### 1. مدل‌های غیرضروری
- `apps/meet/models.py` - حذف شد (نیازی نبود)
- `apps/meet/serializers.py` - حذف شد (نیازی نبود)
- `apps/meet/views.py` - حذف شد (نیازی نبود)
- `apps/meet/urls.py` - حذف شد (نیازی نبود)
- `apps/meet/admin.py` - حذف شد (نیازی نبود)
- `apps/meet/migrations/` - حذف شد (نیازی نبود)

### 2. فایل‌های تست قدیمی
- `test_meet_integration.py` - حذف شد
- `test_meet_sso_flow.py` - حذف شد

## فایل‌های باقی‌مانده

### 1. JWT Utilities (apps/meet/jwt_utils.py)
**مسیر:** `apps/meet/jwt_utils.py`  
**عملکرد:**
- کلاس `MeetJWTGenerator` برای تولید JWT tokens
- بررسی دسترسی کاربر از طریق API خارجی
- تولید JWT با payload کامل مطابق با استاندارد meet
- مدیریت زمان اعتبار توکن بر اساس زمان جلسه

### 2. App Configuration (apps/meet/apps.py)
**مسیر:** `apps/meet/apps.py`  
**عملکرد:** پیکربندی ساده اپلیکیشن meet

### 3. اصلاح SSO Views (sso/views.py)
**مسیر:** `sso/views.py`  
**تغییرات:**
- `handle_meet_callback()` برای پردازش مخصوص meet
- `handle_default_meet_redirect()` برای هدایت پیش‌فرض
- اصلاح `sso_callback_page()` برای تشخیص کلاینت meet

### 4. اسکریپت‌های مدیریت
**مسیر:** `scripts/`  
**فایل‌های باقی‌مانده:**
- `create_meet_client.py` - ایجاد کلاینت SSO برای meet
- `setup_meet_production.py` - راه‌اندازی production

### 5. اسکریپت تست جدید
**مسیر:** ریشه پروژه  
**فایل جدید:**
- `test_meet_jwt_only.py` - تست ساده JWT generation

## نحوه اجرا

### 1. تست سیستم
```bash
python test_meet_jwt_only.py
```

### 2. ایجاد کلاینت SSO
```bash
python scripts/create_meet_client.py
```

### 3. راه‌اندازی Production
```bash
python scripts/setup_meet_production.py
```

## جریان SSO (بدون تغییر)

### 1. شروع جلسه
کاربر روی لینک `meet.avinoo.ir/roomname` کلیک می‌کند

### 2. هدایت به احراز هویت
سیستم meet کاربر را به `http://auth.avinoo.ir/login/?client_id=meet_avinoo&redirect_uri=https://meet.avinoo.ir/roomname` هدایت می‌کند

### 3. ورود کاربر
کاربر در سیستم احراز هویت وارد می‌شود

### 4. بررسی دسترسی
سیستم با API خارجی `http://avinoo.ir/api/meets/access/?room_name=roomname&user_guid=guid` دسترسی کاربر را بررسی می‌کند

### 5. تولید JWT
اگر کاربر دسترسی داشته باشد، JWT token مخصوص meet تولید می‌شود

### 6. هدایت نهایی
کاربر به `https://meet.avinoo.ir/roomname?jwt=TOKEN` هدایت می‌شود

## JWT Token Structure (بدون تغییر)

```json
{
    "aud": "meet_avinoo",
    "iss": "meet_avinoo",
    "sub": "meet.avinoo.ir",
    "room": "roomname",
    "exp": 1736766600,
    "nbf": 1757753436,
    "moderator": true,
    "context": {
        "user": {
            "id": "1",
            "name": "admin",
            "email": "admin@example.com",
            "avatar": "",
            "affiliation": "owner",
            "moderator": true,
            "region": "us-east",
            "displayName": "admin"
        },
        "group": "avinoo-users",
        "features": {
            "livestreaming": true,
            "recording": true,
            "screen-sharing": true,
            "sip": false,
            "etherpad": false,
            "transcription": true,
            "breakout-rooms": false
        }
    },
    "identity": {
        "type": "user",
        "guest": false,
        "externalId": "ext-1"
    },
    "custom": {
        "theme": "green",
        "allowKnocking": true,
        "enablePolls": true
    }
}
```

## مزایای تغییرات

### 1. سادگی
- حذف مدل‌های غیرضروری
- کاهش پیچیدگی کد
- نگهداری آسان‌تر

### 2. کارایی
- استفاده مستقیم از API خارجی
- عدم نیاز به دیتابیس اضافی
- عملکرد بهتر

### 3. انعطاف‌پذیری
- وابستگی کمتر به ساختار داخلی
- قابلیت تغییر API خارجی
- سازگاری بهتر

## تست‌های انجام شده

✅ بررسی وجود کاربر تست  
✅ تست JWT Generator  
✅ تست فراخوانی API خارجی  
✅ تست تولید JWT token  
✅ تست تولید URL بازگشت  
✅ تست فرمت‌بندی اطلاعات کاربر  
✅ شبیه‌سازی جریان SSO  

## تنظیمات Production (بدون تغییر)

### کلاینت SSO
- **شناسه:** meet_avinoo
- **دامنه:** meet.avinoo.ir
- **اجازه هر مسیر:** True
- **فعال:** True

### JWT Settings
- **App ID:** meet_avinoo
- **Domain:** meet.avinoo.ir
- **Secret:** meet_secret_key_2024
- **Algorithm:** HS256

### API خارجی
- **URL:** http://avinoo.ir/api/meets/access/
- **پارامترها:** room_name, user_guid

## نتیجه‌گیری

سیستم به صورت ساده‌تر و کارآمدتر پیاده‌سازی شد. تمام مدل‌های غیرضروری حذف شدند و سیستم فقط روی تولید JWT tokens و استفاده از API خارجی متمرکز شد. عملکرد سیستم بهبود یافت و نگهداری آن آسان‌تر شد.

---

**تهیه شده توسط:** AI Assistant  
**تاریخ:** 13 ژانویه 2025  
**وضعیت:** به‌روزرسانی تکمیل شده ✅
