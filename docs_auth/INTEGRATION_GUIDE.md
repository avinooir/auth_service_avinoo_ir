# ğŸ”— Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø§ØªØµØ§Ù„ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… SSO

## ğŸ“‹ ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨

1. [Ù…Ù‚Ø¯Ù…Ù‡](#Ù…Ù‚Ø¯Ù…Ù‡)
2. [Ù†Ø­ÙˆÙ‡ Ú©Ø§Ø±Ú©Ø±Ø¯ SSO](#Ù†Ø­ÙˆÙ‡-Ú©Ø§Ø±Ú©Ø±Ø¯-sso)
3. [Ù…Ø±Ø§Ø­Ù„ Ø§ØªØµØ§Ù„](#Ù…Ø±Ø§Ø­Ù„-Ø§ØªØµØ§Ù„)
4. [API Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯](#api-Ù‡Ø§ÛŒ-Ù…ÙˆØ¬ÙˆØ¯)
5. [Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ](#Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ-Ø¹Ù…Ù„ÛŒ)
6. [Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§](#Ù…Ø¯ÛŒØ±ÛŒØª-Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§)
7. [Ø§Ù…Ù†ÛŒØª](#Ø§Ù…Ù†ÛŒØª)
8. [Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ](#Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ)

## ğŸ¯ Ù…Ù‚Ø¯Ù…Ù‡

Ø³ÛŒØ³ØªÙ… SSO Ø´Ù…Ø§ Ø§Ù…Ú©Ø§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ú†Ù†Ø¯ÛŒÙ† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±Ø§ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØªØµÙ„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯.

### Ù…Ø²Ø§ÛŒØ§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² SSO:
- **ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ù‡ØªØ±**: ÛŒÚ© Ø¨Ø§Ø± ÙˆØ±ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§
- **Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ù„Ø§ØªØ±**: Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙ…Ø±Ú©Ø² Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
- **Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ø³Ø§Ù†â€ŒØªØ±**: Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø§Ø² ÛŒÚ© Ù…Ú©Ø§Ù†
- **Ú©Ø§Ù‡Ø´ Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒ**: Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¯Ø± Ù‡Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†

## ğŸ”„ Ù†Ø­ÙˆÙ‡ Ú©Ø§Ø±Ú©Ø±Ø¯ SSO

### ÙØ±Ø¢ÛŒÙ†Ø¯ Ú©Ù„ÛŒ:
1. **Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯**
2. **Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ SSO Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯**
3. **Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± SSO ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯**
4. **SSO ØªÙˆÚ©Ù† JWT ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯**
5. **Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ ØªÙˆÚ©Ù† Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø§Ø²Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯**
6. **Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† ØªÙˆÚ©Ù† Ø±Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯**
7. **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² SSO Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯**

## ğŸš€ Ù…Ø±Ø§Ø­Ù„ Ø§ØªØµØ§Ù„

### Ù…Ø±Ø­Ù„Ù‡ 1: Ø«Ø¨Øª Ú©Ù„Ø§ÛŒÙ†Øª Ø¯Ø± SSO

Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… SSO Ø«Ø¨Øª Ú©Ù†ÛŒØ¯:

#### Ø±ÙˆØ´ 1: Ø§Ø² Ø·Ø±ÛŒÙ‚ Django Admin
```bash
# Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
http://127.0.0.1:8000/admin/sso/ssoclient/
```

#### Ø±ÙˆØ´ 2: Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø¯ÛŒØ±ÛŒØª
```bash
python scripts/manage_sso_clients.py
```

#### Ø±ÙˆØ´ 3: Ø§Ø² Ø·Ø±ÛŒÙ‚ API (Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†)
```python
import requests

# Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª Ø¬Ø¯ÛŒØ¯
response = requests.post('http://127.0.0.1:8000/sso/api/admin/clients/', {
    'name': 'My Application',
    'domain': 'myapp.example.com',
    'client_id': 'myapp_client',
    'client_secret': 'myapp_secret_2024',
    'redirect_uri': 'https://myapp.example.com/callback',
    'allow_any_path': True,  # Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¹Ø·Ø§Ù Ø¨ÛŒØ´ØªØ±
    'is_active': True
}, headers={'Authorization': 'Bearer YOUR_ADMIN_TOKEN'})
```

### Ù…Ø±Ø­Ù„Ù‡ 2: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„Ø§ÛŒÙ†Øª

Ù‡Ø± Ú©Ù„Ø§ÛŒÙ†Øª Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:

```json
{
    "client_id": "myapp_client",
    "client_secret": "myapp_secret_2024",
    "domain": "myapp.example.com",
    "redirect_uri": "https://myapp.example.com/callback",
    "allow_any_path": true
}
```

### Ù…Ø±Ø­Ù„Ù‡ 3: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†

## ğŸ“¡ API Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯

### 1. API ÙˆØ±ÙˆØ¯ (Login)

**Endpoint:** `POST /sso/api/login/`

**Ø¯Ø±Ø®ÙˆØ§Ø³Øª:**
```json
{
    "username": "user123",
    "password": "password123",
    "client_id": "myapp_client",
    "redirect_uri": "https://myapp.example.com/callback",
    "state": "optional_state_parameter"
}
```

**Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚:**
```json
{
    "success": true,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "token_type": "Bearer",
    "expires_in": 900,
    "redirect_uri": "https://myapp.example.com/callback?jwt=TOKEN&state=STATE",
    "user": {
        "id": 1,
        "username": "user123",
        "email": "user@example.com",
        "first_name": "John",
        "last_name": "Doe"
    }
}
```

### 2. API Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Register)

**Endpoint:** `POST /sso/api/register/`

**Ø¯Ø±Ø®ÙˆØ§Ø³Øª:**
```json
{
    "username": "newuser",
    "email": "newuser@example.com",
    "password": "password123",
    "password_confirm": "password123",
    "first_name": "New",
    "last_name": "User",
    "client_id": "myapp_client",
    "redirect_uri": "https://myapp.example.com/callback"
}
```

### 3. API Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†

**Endpoint:** `POST /sso/api/validate-token/`

**Ø¯Ø±Ø®ÙˆØ§Ø³Øª:**
```json
{
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "client_id": "myapp_client"
}
```

**Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚:**
```json
{
    "success": true,
    "valid": true,
    "user": {
        "id": 1,
        "username": "user123",
        "email": "user@example.com",
        "first_name": "John",
        "last_name": "Doe",
        "is_active": true
    },
    "token_info": {
        "exp": 1640995200,
        "iat": 1640991600,
        "jti": "token_id"
    }
}
```

### 4. API Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±

**Endpoint:** `GET /sso/api/user-info/`

**Headers:**
```
Authorization: Bearer <access_token>
```

**Ù¾Ø§Ø³Ø®:**
```json
{
    "success": true,
    "user": {
        "id": 1,
        "username": "user123",
        "email": "user@example.com",
        "first_name": "John",
        "last_name": "Doe",
        "phone_number": "+989123456789",
        "is_active": true,
        "date_joined": "2024-01-01T12:00:00Z",
        "last_login": "2024-01-01T12:00:00Z"
    }
}
```

### 5. API Ø®Ø±ÙˆØ¬ (Logout)

**Endpoint:** `POST /sso/api/logout/`

**Ø¯Ø±Ø®ÙˆØ§Ø³Øª:**
```json
{
    "client_id": "myapp_client",
    "redirect_uri": "https://myapp.example.com/",
    "jwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

## ğŸ’» Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ

### 1. Ø§ØªØµØ§Ù„ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† React

```javascript
// SSO Service
class SSOService {
    constructor(baseURL, clientId) {
        this.baseURL = baseURL;
        this.clientId = clientId;
    }

    // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ SSO
    redirectToLogin(redirectUri, state = null) {
        const params = new URLSearchParams({
            client_id: this.clientId,
            redirect_uri: redirectUri
        });
        
        if (state) {
            params.append('state', state);
        }

        window.location.href = `${this.baseURL}/sso/login/?${params.toString()}`;
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
    async validateToken(token) {
        try {
            const response = await fetch(`${this.baseURL}/sso/api/validate-token/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: token,
                    client_id: this.clientId
                })
            });

            return await response.json();
        } catch (error) {
            console.error('Token validation error:', error);
            return { success: false, error: error.message };
        }
    }

    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
    async getUserInfo(token) {
        try {
            const response = await fetch(`${this.baseURL}/sso/api/user-info/`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            return await response.json();
        } catch (error) {
            console.error('Get user info error:', error);
            return { success: false, error: error.message };
        }
    }

    // Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…
    async logout(token, redirectUri) {
        try {
            const response = await fetch(`${this.baseURL}/sso/api/logout/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    client_id: this.clientId,
                    redirect_uri: redirectUri,
                    jwt: token
                })
            });

            return await response.json();
        } catch (error) {
            console.error('Logout error:', error);
            return { success: false, error: error.message };
        }
    }
}

// Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª React
import React, { useEffect, useState } from 'react';

const App = () => {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    const ssoService = new SSOService('http://127.0.0.1:8000', 'myapp_client');

    useEffect(() => {
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ØªÙˆÚ©Ù† Ø¯Ø± URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('jwt');
        
        if (token) {
            // Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù†
            localStorage.setItem('sso_token', token);
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø§Ø² URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            loadUserInfo(token);
        } else {
            // Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù† Ù…ÙˆØ¬ÙˆØ¯
            const existingToken = localStorage.getItem('sso_token');
            if (existingToken) {
                loadUserInfo(existingToken);
            } else {
                setLoading(false);
            }
        }
    }, []);

    const loadUserInfo = async (token) => {
        try {
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
            const validation = await ssoService.validateToken(token);
            
            if (validation.success && validation.valid) {
                // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
                const userInfo = await ssoService.getUserInfo(token);
                
                if (userInfo.success) {
                    setUser(userInfo.user);
                } else {
                    // ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                    localStorage.removeItem('sso_token');
                }
            } else {
                // ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                localStorage.removeItem('sso_token');
            }
        } catch (error) {
            console.error('Error loading user info:', error);
            localStorage.removeItem('sso_token');
        } finally {
            setLoading(false);
        }
    };

    const handleLogin = () => {
        const redirectUri = window.location.origin + window.location.pathname;
        ssoService.redirectToLogin(redirectUri);
    };

    const handleLogout = async () => {
        const token = localStorage.getItem('sso_token');
        if (token) {
            const redirectUri = window.location.origin;
            await ssoService.logout(token, redirectUri);
        }
        
        localStorage.removeItem('sso_token');
        setUser(null);
    };

    if (loading) {
        return <div>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>;
    }

    if (!user) {
        return (
            <div>
                <h1>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h1>
                <button onClick={handleLogin}>ÙˆØ±ÙˆØ¯</button>
            </div>
        );
    }

    return (
        <div>
            <h1>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ {user.first_name} {user.last_name}</h1>
            <p>Ø§ÛŒÙ…ÛŒÙ„: {user.email}</p>
            <p>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: {user.username}</p>
            <button onClick={handleLogout}>Ø®Ø±ÙˆØ¬</button>
        </div>
    );
};

export default App;
```

### 2. Ø§ØªØµØ§Ù„ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Python (Flask)

```python
import os
import requests
from flask import Flask, request, redirect, session, render_template, jsonify
from functools import wraps

app = Flask(__name__)
app.secret_key = 'your-secret-key'

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª SSO
SSO_BASE_URL = 'http://127.0.0.1:8000'
CLIENT_ID = 'myapp_client'
CLIENT_SECRET = 'myapp_secret_2024'

class SSOService:
    def __init__(self, base_url, client_id, client_secret):
        self.base_url = base_url
        self.client_id = client_id
        self.client_secret = client_secret

    def get_login_url(self, redirect_uri, state=None):
        """ØªÙˆÙ„ÛŒØ¯ URL ÙˆØ±ÙˆØ¯ SSO"""
        params = {
            'client_id': self.client_id,
            'redirect_uri': redirect_uri
        }
        if state:
            params['state'] = state
        
        param_string = '&'.join([f'{k}={v}' for k, v in params.items()])
        return f'{self.base_url}/sso/login/?{param_string}'

    def validate_token(self, token):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†"""
        try:
            response = requests.post(
                f'{self.base_url}/sso/api/validate-token/',
                json={
                    'token': token,
                    'client_id': self.client_id
                }
            )
            return response.json()
        except Exception as e:
            return {'success': False, 'error': str(e)}

    def get_user_info(self, token):
        """Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±"""
        try:
            response = requests.get(
                f'{self.base_url}/sso/api/user-info/',
                headers={'Authorization': f'Bearer {token}'}
            )
            return response.json()
        except Exception as e:
            return {'success': False, 'error': str(e)}

    def logout(self, token, redirect_uri):
        """Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…"""
        try:
            response = requests.post(
                f'{self.base_url}/sso/api/logout/',
                json={
                    'client_id': self.client_id,
                    'redirect_uri': redirect_uri,
                    'jwt': token
                }
            )
            return response.json()
        except Exception as e:
            return {'success': False, 'error': str(e)}

# Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡ SSO Service
sso_service = SSOService(SSO_BASE_URL, CLIENT_ID, CLIENT_SECRET)

def login_required(f):
    """Ø¯Ú©ÙˆØ±Ø§ØªÙˆØ± Ø¨Ø±Ø§ÛŒ ØµÙØ­Ø§Øª Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ÙˆØ±ÙˆØ¯"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = session.get('sso_token')
        if not token:
            return redirect_to_login()
        
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
        validation = sso_service.validate_token(token)
        if not validation.get('success') or not validation.get('valid'):
            session.pop('sso_token', None)
            return redirect_to_login()
        
        return f(*args, **kwargs)
    return decorated_function

def redirect_to_login():
    """Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ SSO"""
    redirect_uri = request.url_root + 'callback'
    login_url = sso_service.get_login_url(redirect_uri)
    return redirect(login_url)

@app.route('/')
def index():
    """ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ"""
    token = session.get('sso_token')
    if not token:
        return render_template('login.html')
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
    user_info = sso_service.get_user_info(token)
    if user_info.get('success'):
        return render_template('dashboard.html', user=user_info['user'])
    else:
        session.pop('sso_token', None)
        return redirect_to_login()

@app.route('/callback')
def callback():
    """ØµÙØ­Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø² SSO"""
    token = request.args.get('jwt')
    state = request.args.get('state')
    
    if not token:
        return render_template('error.html', error='ØªÙˆÚ©Ù† Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯')
    
    # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
    validation = sso_service.validate_token(token)
    if validation.get('success') and validation.get('valid'):
        session['sso_token'] = token
        return redirect('/')
    else:
        return render_template('error.html', error='ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª')

@app.route('/dashboard')
@login_required
def dashboard():
    """ØµÙØ­Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ÙˆØ±ÙˆØ¯)"""
    token = session.get('sso_token')
    user_info = sso_service.get_user_info(token)
    
    if user_info.get('success'):
        return render_template('dashboard.html', user=user_info['user'])
    else:
        return render_template('error.html', error='Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±')

@app.route('/logout')
def logout():
    """Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…"""
    token = session.get('sso_token')
    if token:
        redirect_uri = request.url_root
        sso_service.logout(token, redirect_uri)
    
    session.pop('sso_token', None)
    return redirect('/')

@app.route('/api/user')
@login_required
def api_user():
    """API Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±"""
    token = session.get('sso_token')
    user_info = sso_service.get_user_info(token)
    
    if user_info.get('success'):
        return jsonify(user_info['user'])
    else:
        return jsonify({'error': 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±'}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)
```

### 3. Ø§ØªØµØ§Ù„ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† PHP

```php
<?php
class SSOService {
    private $baseUrl;
    private $clientId;
    private $clientSecret;
    
    public function __construct($baseUrl, $clientId, $clientSecret) {
        $this->baseUrl = $baseUrl;
        $this->clientId = $clientId;
        $this->clientSecret = $clientSecret;
    }
    
    public function getLoginUrl($redirectUri, $state = null) {
        $params = [
            'client_id' => $this->clientId,
            'redirect_uri' => $redirectUri
        ];
        
        if ($state) {
            $params['state'] = $state;
        }
        
        return $this->baseUrl . '/sso/login/?' . http_build_query($params);
    }
    
    public function validateToken($token) {
        $data = [
            'token' => $token,
            'client_id' => $this->clientId
        ];
        
        $response = $this->makeRequest('/sso/api/validate-token/', 'POST', $data);
        return json_decode($response, true);
    }
    
    public function getUserInfo($token) {
        $headers = [
            'Authorization: Bearer ' . $token
        ];
        
        $response = $this->makeRequest('/sso/api/user-info/', 'GET', null, $headers);
        return json_decode($response, true);
    }
    
    public function logout($token, $redirectUri) {
        $data = [
            'client_id' => $this->clientId,
            'redirect_uri' => $redirectUri,
            'jwt' => $token
        ];
        
        $response = $this->makeRequest('/sso/api/logout/', 'POST', $data);
        return json_decode($response, true);
    }
    
    private function makeRequest($endpoint, $method = 'GET', $data = null, $headers = []) {
        $url = $this->baseUrl . $endpoint;
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array_merge([
            'Content-Type: application/json'
        ], $headers));
        
        if ($method === 'POST' && $data) {
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        }
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        if ($httpCode !== 200) {
            throw new Exception('HTTP Error: ' . $httpCode);
        }
        
        return $response;
    }
}

// Ø§Ø³ØªÙØ§Ø¯Ù‡
session_start();

$ssoService = new SSOService('http://127.0.0.1:8000', 'myapp_client', 'myapp_secret_2024');

// Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù† Ø¯Ø± URL
if (isset($_GET['jwt'])) {
    $token = $_GET['jwt'];
    
    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
    $validation = $ssoService->validateToken($token);
    
    if ($validation['success'] && $validation['valid']) {
        $_SESSION['sso_token'] = $token;
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø§Ø² URL
        header('Location: ' . strtok($_SERVER["REQUEST_URI"], '?'));
        exit;
    }
}

// Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù† Ù…ÙˆØ¬ÙˆØ¯
$token = $_SESSION['sso_token'] ?? null;

if (!$token) {
    // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ÙˆØ±ÙˆØ¯
    $redirectUri = 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
    $loginUrl = $ssoService->getLoginUrl($redirectUri);
    header('Location: ' . $loginUrl);
    exit;
}

// Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†
$validation = $ssoService->validateToken($token);

if (!$validation['success'] || !$validation['valid']) {
    // ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
    unset($_SESSION['sso_token']);
    $redirectUri = 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
    $loginUrl = $ssoService->getLoginUrl($redirectUri);
    header('Location: ' . $loginUrl);
    exit;
}

// Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
$userInfo = $ssoService->getUserInfo($token);

if (!$userInfo['success']) {
    die('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±');
}

$user = $userInfo['user'];
?>

<!DOCTYPE html>
<html>
<head>
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ <?php echo htmlspecialchars($user['first_name'] . ' ' . $user['last_name']); ?></h1>
    <p>Ø§ÛŒÙ…ÛŒÙ„: <?php echo htmlspecialchars($user['email']); ?></p>
    <p>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <?php echo htmlspecialchars($user['username']); ?></p>
    
    <a href="logout.php">Ø®Ø±ÙˆØ¬</a>
</body>
</html>
```

## ğŸ”§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§

### Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª Ø¬Ø¯ÛŒØ¯

```python
# Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª
import os
import sys
import django

# Setup Django
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'auth_service.settings')
django.setup()

from sso.models import SSOClient

def create_client():
    client = SSOClient.objects.create(
        name='My New Application',
        domain='myapp.example.com',
        client_id='myapp_client_2024',
        client_secret='myapp_secret_2024',
        redirect_uri='https://myapp.example.com/callback',
        allowed_redirect_uris=[
            'https://myapp.example.com/callback',
            'https://myapp.example.com/auth/callback'
        ],
        allow_any_path=True,  # Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¹Ø·Ø§Ù Ø¨ÛŒØ´ØªØ±
        is_active=True
    )
    
    print(f"âœ… Ú©Ù„Ø§ÛŒÙ†Øª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: {client.name}")
    print(f"   Client ID: {client.client_id}")
    print(f"   Domain: {client.domain}")
    print(f"   Allow any path: {client.allow_any_path}")

if __name__ == '__main__':
    create_client()
```

### Ù„ÛŒØ³Øª Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯

```python
from sso.models import SSOClient

def list_clients():
    clients = SSOClient.objects.filter(is_active=True)
    
    print("ğŸ“‹ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„:")
    for client in clients:
        print(f"\nğŸ”¹ {client.name}")
        print(f"   Client ID: {client.client_id}")
        print(f"   Domain: {client.domain}")
        print(f"   Allow any path: {'âœ… Yes' if client.allow_any_path else 'âŒ No'}")
        print(f"   Created: {client.created_at}")

if __name__ == '__main__':
    list_clients()
```

## ğŸ”’ Ø§Ù…Ù†ÛŒØª

### Ù†Ú©Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ Ù…Ù‡Ù…:

1. **Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² HTTPS**: Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² HTTPS Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
2. **Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² Client Secret**: Client Secret Ø±Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· production Ù…Ø­ÙÙˆØ¸ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯
3. **Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†**: Ù‡Ù…ÛŒØ´Ù‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ù†ÛŒØ¯
4. **Ù…Ø¯ÛŒØ±ÛŒØª Session**: ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯
5. **Rate Limiting**: Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯

### Ù…Ø«Ø§Ù„ Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù†:

```javascript
// Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…Ù† ØªÙˆÚ©Ù†
class SecureTokenStorage {
    static setToken(token) {
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² httpOnly cookie Ø¯Ø± production
        if (process.env.NODE_ENV === 'production') {
            // ØªÙ†Ø¸ÛŒÙ… cookie Ø§Ù…Ù†
            document.cookie = `sso_token=${token}; secure; httpOnly; sameSite=strict`;
        } else {
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² localStorage Ø¯Ø± development
            localStorage.setItem('sso_token', token);
        }
    }
    
    static getToken() {
        if (process.env.NODE_ENV === 'production') {
            // Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'sso_token') {
                    return value;
                }
            }
            return null;
        } else {
            return localStorage.getItem('sso_token');
        }
    }
    
    static removeToken() {
        if (process.env.NODE_ENV === 'production') {
            document.cookie = 'sso_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        } else {
            localStorage.removeItem('sso_token');
        }
    }
}
```

## ğŸ› Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ

### Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ÛŒØ¬ Ùˆ Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§:

#### 1. Ø®Ø·Ø§ÛŒ "Ú©Ù„Ø§ÛŒÙ†Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª"
```bash
# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ù„Ø§ÛŒÙ†Øª
python manage.py shell
>>> from sso.models import SSOClient
>>> SSOClient.objects.filter(client_id='your_client_id')
```

#### 2. Ø®Ø·Ø§ÛŒ "Ø¢Ø¯Ø±Ø³ Ø¨Ø§Ø²Ú¯Ø´Øª Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª"
```bash
# Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª redirect_uri
>>> client = SSOClient.objects.get(client_id='your_client_id')
>>> client.is_redirect_uri_allowed('https://yourdomain.com/callback')
```

#### 3. Ø®Ø·Ø§ÛŒ "ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª"
```python
# Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù†
import jwt
from django.conf import settings

def decode_token(token):
    try:
        decoded = jwt.decode(token, settings.SECRET_KEY, algorithms=['HS256'])
        return decoded
    except jwt.ExpiredSignatureError:
        return {'error': 'ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡'}
    except jwt.InvalidTokenError:
        return {'error': 'ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}
```

#### 4. Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
```bash
# Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ SSO
tail -f logs/django.log | grep SSO
```

### Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ:

```python
# Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ
import requests
import json

def debug_sso_connection():
    base_url = 'http://127.0.0.1:8000'
    client_id = 'your_client_id'
    
    print("ğŸ” Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ Ø§ØªØµØ§Ù„ SSO")
    print("=" * 50)
    
    # ØªØ³Øª 1: Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ SSO
    try:
        response = requests.get(f'{base_url}/sso/api/user-info/')
        print(f"âœ… SSO Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª (Status: {response.status_code})")
    except Exception as e:
        print(f"âŒ SSO Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª: {e}")
        return
    
    # ØªØ³Øª 2: Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª
    try:
        response = requests.post(f'{base_url}/sso/api/validate-token/', json={
            'token': 'test_token',
            'client_id': client_id
        })
        print(f"âœ… Ú©Ù„Ø§ÛŒÙ†Øª Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Status: {response.status_code})")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù„Ø§ÛŒÙ†Øª: {e}")
    
    # ØªØ³Øª 3: Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
    print(f"\nğŸ“‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ù„ÛŒ:")
    print(f"   Base URL: {base_url}")
    print(f"   Client ID: {client_id}")
    print(f"   Redirect URI: https://yourdomain.com/callback")

if __name__ == '__main__':
    debug_sso_connection()
```

## ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ

Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù…Ú© Ø¨ÛŒØ´ØªØ±:

1. **Ù…Ø³ØªÙ†Ø¯Ø§Øª Ú©Ø§Ù…Ù„**: `docs/API.md`
2. **Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±**: `examples/`
3. **Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª**: `scripts/`
4. **Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…**: `logs/django.log`

---

**Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…**: Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ Ø³ÛŒØ³ØªÙ… SSO Ø´Ù…Ø§ ØªÙ‡ÛŒÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ùˆ ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÛŒØ¯ØŒ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.
