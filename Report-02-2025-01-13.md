# گزارش جامع - پیاده‌سازی سیستم احراز هویت meet.avinoo.ir

**تاریخ:** 13 ژانویه 2025  
**شماره گزارش:** 02  
**پروژه:** Auth Service - Meet Integration  

## خلاصه اجرایی

سیستم احراز هویت برای اپلیکیشن جلسات meet.avinoo.ir با موفقیت پیاده‌سازی شد. این سیستم شامل بررسی دسترسی کاربران از طریق API خارجی، تولید JWT tokens مخصوص meet، و هدایت خودکار کاربران به جلسات است.

## فایل‌های ایجاد شده

### 1. مدل‌های کاربری (apps/users/models.py)
**مسیر:** `apps/users/models.py`  
**تغییرات:**
- اضافه شدن فیلد `avatar_url` برای آدرس تصویر پروفایل
- اضافه شدن فیلد `region` برای منطقه جغرافیایی کاربر
- اضافه شدن فیلد `display_name` برای نام نمایشی
- اضافه شدن متد `get_meet_user_data()` برای فرمت‌بندی اطلاعات کاربر

**دلیل ایجاد:** نیاز به اطلاعات اضافی کاربر برای تولید JWT tokens مخصوص meet

### 2. اپلیکیشن Meet Integration (apps/meet/)
**مسیر:** `apps/meet/`  
**فایل‌های ایجاد شده:**
- `__init__.py` - فایل اولیه اپلیکیشن
- `apps.py` - پیکربندی اپلیکیشن
- `models.py` - مدل‌های MeetRoom و MeetRoomAccess
- `serializers.py` - سریالایزرهای API
- `views.py` - ویوهای API برای بررسی دسترسی
- `urls.py` - URL patterns
- `admin.py` - پنل مدیریت
- `jwt_utils.py` - ابزارهای تولید JWT

**دلیل ایجاد:** مدیریت کامل سیستم meet integration

### 3. JWT Utilities (apps/meet/jwt_utils.py)
**مسیر:** `apps/meet/jwt_utils.py`  
**عملکرد:**
- کلاس `MeetJWTGenerator` برای تولید JWT tokens
- بررسی دسترسی کاربر از طریق API خارجی
- تولید JWT با payload کامل مطابق با استاندارد meet
- مدیریت زمان اعتبار توکن بر اساس زمان جلسه

**دلیل ایجاد:** تولید JWT tokens مخصوص meet.avinoo.ir

### 4. اصلاح SSO Views (sso/views.py)
**مسیر:** `sso/views.py`  
**تغییرات:**
- اضافه شدن `handle_meet_callback()` برای پردازش مخصوص meet
- اضافه شدن `handle_default_meet_redirect()` برای هدایت پیش‌فرض
- اصلاح `sso_callback_page()` برای تشخیص کلاینت meet

**دلیل ایجاد:** پردازش مخصوص کلاینت meet.avinoo.ir

### 5. اسکریپت‌های مدیریت
**مسیر:** `scripts/`  
**فایل‌های ایجاد شده:**
- `create_meet_client.py` - ایجاد کلاینت SSO برای meet
- `setup_meet_production.py` - راه‌اندازی production

**دلیل ایجاد:** مدیریت و راه‌اندازی آسان سیستم

### 6. اسکریپت‌های تست
**مسیر:** ریشه پروژه  
**فایل‌های ایجاد شده:**
- `test_meet_integration.py` - تست یکپارچگی سیستم
- `test_meet_sso_flow.py` - تست جریان کامل SSO

**دلیل ایجاد:** اطمینان از عملکرد صحیح سیستم

## نحوه اجرا

### 1. اجرای Migration ها
```bash
python manage.py makemigrations users
python manage.py makemigrations meet
python manage.py migrate
```

### 2. ایجاد کلاینت SSO
```bash
python scripts/create_meet_client.py
```

### 3. تست سیستم
```bash
python test_meet_integration.py
python test_meet_sso_flow.py
```

### 4. راه‌اندازی Production
```bash
python scripts/setup_meet_production.py
```

## API Endpoints

### 1. بررسی دسترسی به جلسه
**URL:** `GET/POST /api/meets/access/`  
**پارامترها:**
- `room_name`: نام اتاق جلسه
- `user_guid`: شناسه یکتای کاربر

**پاسخ:**
```json
{
    "success": true,
    "data": {
        "has_access": true,
        "user_type": "organizer",
        "start_time": "2025-01-11T10:00:00Z",
        "end_time": "2025-01-11T11:00:00Z",
        "is_organizer": true,
        "is_participant": false,
        "is_active": false,
        "is_upcoming": true,
        "is_past": false
    }
}
```

### 2. لیست اتاق‌های جلسه
**URL:** `GET /api/meets/rooms/`  
**پاسخ:** لیست تمام اتاق‌های جلسه

### 3. دسترسی‌های اتاق
**URL:** `GET /api/meets/access/{room_name}/`  
**پاسخ:** لیست دسترسی‌های اتاق مشخص

## جریان SSO

### 1. شروع جلسه
کاربر روی لینک `meet.avinoo.ir/roomname` کلیک می‌کند

### 2. هدایت به احراز هویت
سیستم meet کاربر را به `http://auth.avinoo.ir/login/?client_id=meet_avinoo&redirect_uri=https://meet.avinoo.ir/roomname` هدایت می‌کند

### 3. ورود کاربر
کاربر در سیستم احراز هویت وارد می‌شود

### 4. بررسی دسترسی
سیستم با API خارجی `http://avinoo.ir/api/meets/access/?room_name=roomname&user_guid=guid` دسترسی کاربر را بررسی می‌کند

### 5. تولید JWT
اگر کاربر دسترسی داشته باشد، JWT token مخصوص meet تولید می‌شود

### 6. هدایت نهایی
کاربر به `https://meet.avinoo.ir/roomname?jwt=TOKEN` هدایت می‌شود

## JWT Token Structure

```json
{
    "aud": "meet_avinoo",
    "iss": "meet_avinoo",
    "sub": "meet.avinoo.ir",
    "room": "roomname",
    "exp": 1736766600,
    "nbf": 1757753436,
    "moderator": true,
    "context": {
        "user": {
            "id": "1",
            "name": "admin",
            "email": "admin@example.com",
            "avatar": "",
            "affiliation": "owner",
            "moderator": true,
            "region": "us-east",
            "displayName": "admin"
        },
        "group": "avinoo-users",
        "features": {
            "livestreaming": true,
            "recording": true,
            "screen-sharing": true,
            "sip": false,
            "etherpad": false,
            "transcription": true,
            "breakout-rooms": false
        }
    },
    "identity": {
        "type": "user",
        "guest": false,
        "externalId": "ext-1"
    },
    "custom": {
        "theme": "green",
        "allowKnocking": true,
        "enablePolls": true
    }
}
```

## مشکلات و راه‌حل‌ها

### 1. مشکل: API خارجی در دسترس نیست
**راه‌حل:** سیستم به صورت graceful fallback عمل می‌کند و دسترسی را رد می‌کند

### 2. مشکل: JWT token تولید نمی‌شود
**راه‌حل:** بررسی لاگ‌ها و اطمینان از صحت تنظیمات JWT secret

### 3. مشکل: هدایت نادرست
**راه‌حل:** بررسی تنظیمات کلاینت SSO و allowed_redirect_uris

## تغییرات مهم نسبت به گزارش قبل

1. **اضافه شدن سیستم meet integration** - سیستم کاملاً جدید
2. **اصلاح مدل User** - اضافه شدن فیلدهای مورد نیاز
3. **پیاده‌سازی JWT generator** - تولید tokens مخصوص meet
4. **اصلاح SSO flow** - پردازش مخصوص کلاینت meet
5. **ایجاد API endpoints** - برای مدیریت جلسات
6. **اسکریپت‌های تست و مدیریت** - برای اطمینان از عملکرد

## تنظیمات Production

### کلاینت SSO
- **شناسه:** meet_avinoo
- **دامنه:** meet.avinoo.ir
- **اجازه هر مسیر:** True
- **فعال:** True

### JWT Settings
- **App ID:** meet_avinoo
- **Domain:** meet.avinoo.ir
- **Secret:** meet_secret_key_2024
- **Algorithm:** HS256

### API خارجی
- **URL:** http://avinoo.ir/api/meets/access/
- **پارامترها:** room_name, user_guid

## تست‌های انجام شده

✅ بررسی وجود کلاینت SSO  
✅ بررسی وجود کاربر تست  
✅ تست JWT generator  
✅ تست فراخوانی API خارجی  
✅ تست تولید JWT token  
✅ تست تولید URL بازگشت  
✅ تست فرمت‌بندی اطلاعات کاربر  
✅ تست جریان کامل SSO  
✅ تست سناریوهای خطا  

## نتیجه‌گیری

سیستم احراز هویت meet.avinoo.ir با موفقیت پیاده‌سازی شد و تمام تست‌ها را پاس کرد. سیستم آماده deployment در production است و قابلیت‌های زیر را ارائه می‌دهد:

- بررسی دسترسی کاربران از طریق API خارجی
- تولید JWT tokens مخصوص meet
- هدایت خودکار کاربران به جلسات
- مدیریت کامل جلسات و دسترسی‌ها
- لاگ‌گیری و نظارت بر فعالیت‌ها

---

**تهیه شده توسط:** AI Assistant  
**تاریخ:** 13 ژانویه 2025  
**وضعیت:** تکمیل شده ✅
