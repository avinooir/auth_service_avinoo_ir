# گزارش جامع - حل مشکل مایگریشن GUID

**تاریخ:** 13 ژانویه 2025  
**شماره گزارش:** 01  
**موضوع:** حل مشکل UNIQUE constraint failed در مایگریشن GUID

## 📋 خلاصه مشکل

```
django.db.utils.IntegrityError: UNIQUE constraint failed: new__users.guid
```

مشکل در مایگریشن `0002_user_guid.py` بود که سعی می‌کرد فیلد `guid` با constraint UNIQUE به جدول `users` اضافه کند، اما کاربران موجود GUID نداشتند.

## 🔧 مراحل حل مشکل

### 1. حذف مایگریشن مشکل‌دار
- **فایل حذف شده:** `apps/users/migrations/0002_user_guid.py`
- **دلیل:** مایگریشن دارای مشکل UNIQUE constraint بود

### 2. ایجاد مایگریشن جدید
- **فایل ایجاد شده:** `apps/users/migrations/0002_user_guid.py`
- **ویژگی‌ها:**
  - اضافه کردن فیلد GUID بدون constraint
  - تولید GUID برای کاربران موجود
  - اعمال unique constraint در مرحله آخر

### 3. اجرای مایگریشن
- **روش:** استفاده از اسکریپت سفارشی برای حل مشکل
- **نتیجه:** تمام کاربران GUID دریافت کردند

### 4. تست و بررسی
- **تست GUID کاربران:** ✅ موفق
- **تست JWT Token:** ✅ موفق
- **تست API Response:** ✅ موفق

## 📊 نتایج نهایی

### وضعیت کاربران
- **تعداد کل کاربران:** 3
- **کاربران با GUID:** 3 (100%)
- **کاربران بدون GUID:** 0

### نمونه GUID ها
```
admin: 6f99b0b3-33e7-49da-8ce9-7b1b7450c2bb
testuser: 9c8a09db-4458-4b2a-8c6a-535a787811de
mohammad: e6ee6a9a-54b5-445b-b8b1-46b33e9b04a4
```

### تست JWT Token
- **GUID در Token:** ✅ موجود است
- **مثال:** `6f99b0b3-33e7-49da-8ce9-7b1b7450c2bb`

## 🎯 تغییرات مهم

### فایل‌های تغییر یافته
1. **`apps/users/migrations/0002_user_guid.py`** - مایگریشن جدید
2. **`MIGRATION_FIX.md`** - مستندات حل مشکل

### فایل‌های موقت (حذف شده)
- `check_users.py` - اسکریپت بررسی کاربران
- `fix_guid_migration.py` - اسکریپت حل مشکل
- `test_guid_fix.py` - اسکریپت تست جامع
- `simple_test.py` - تست ساده

## 🚀 نحوه اجرا

### بررسی وضعیت
```bash
python manage.py showmigrations users
```

### تست GUID
```python
from django.contrib.auth import get_user_model
User = get_user_model()
for user in User.objects.all():
    print(f"{user.username}: {user.guid}")
```

### تست JWT Token
```python
from apps.users.jwt_serializers import CustomRefreshToken
import jwt

user = User.objects.first()
refresh = CustomRefreshToken.for_user(user)
access_token = refresh.access_token

decoded = jwt.decode(str(access_token), options={"verify_signature": False})
print(f"GUID in token: {decoded.get('guid')}")
```

## ✅ مشکلات حل شده

1. **UNIQUE constraint failed** - حل شد
2. **کاربران بدون GUID** - حل شد
3. **مایگریشن ناموفق** - حل شد
4. **JWT Token بدون GUID** - حل شد

## 📈 وضعیت فعلی

- ✅ تمام کاربران GUID دارند
- ✅ GUID در JWT Token موجود است
- ✅ GUID در API responses موجود است
- ✅ مایگریشن‌ها اجرا شده‌اند
- ✅ دیتابیس سالم است

## 🔮 توصیه‌ها

1. **پشتیبان‌گیری:** قبل از هر مایگریشن مهم
2. **تست:** همیشه مایگریشن‌ها را در محیط تست بررسی کنید
3. **مستندسازی:** تغییرات مهم را مستند کنید
4. **نظارت:** وضعیت دیتابیس را مرتب بررسی کنید

---

**گزارش تهیه شده توسط:** AI Assistant  
**وضعیت:** تکمیل شده ✅
